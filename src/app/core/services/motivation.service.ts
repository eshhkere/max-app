import { Injectable, signal, inject } from '@angular/core';
import { StorageService } from './storage.service';

// ะคัะฐะทั ะฟะพ ะฟัะธัะธะฝะฐะผ ัะดะฐัะธ (ะฝะฐ ััััะบะพะผ)
const PHRASES_BY_REASON: Record<string, string[]> = {
  'distraction': [
    'ะกะตะณะพะดะฝั ัั ัะธะปัะฝะตะต ะพัะฒะปะตัะตะฝะธะน! ๐ช',
    'ะคะพะบัั โ ัะฒะพั ะพััะถะธะต ะฟัะพัะธะฒ ัะฐะพัะฐ ๐ฏ',
  ],
  'emergency': [
    'ะะตัะตะณะธ ัะตะฑั! ะะตัะฝััััั ัะธะปัะฝะตะต ๐ฟ',
    'ะะฐะถะฝัะต ะดะตะปะฐ ััะตะฑััั ะฒะฝะธะผะฐะฝะธั โจ',
  ],
  'too-hard': [
    'ะกะปะพะถะฝะพ โ ะฝะต ะทะฝะฐัะธั ะฝะตะฒะพะทะผะพะถะฝะพ! ๐ฅ',
    'ะะฐะถะดะฐั ะฟะพะฟััะบะฐ ะดะตะปะฐะตั ัะตะฑั ัะธะปัะฝะตะต ๐ช',
  ],
  'fatigue': [
    'ะัะดัั = ัะฐััั ััะฟะตัะฐ ๐ค',
    'ะัะดะพัะฝัะป? ะะพะบะฐะถะธ ะฝะฐ ััะพ ัะฟะพัะพะฑะตะฝ! โก',
  ],
  'technical': [
    'ะขะตัะฝะธัะตัะบะธะต ะฟัะพะฑะปะตะผั ะฒัะตะผะตะฝะฝั ๐๏ธ',
    'ะกะฑะพะธ ัะปััะฐัััั, ะณะปะฐะฒะฝะพะต โ ะฝะต ัะดะฐะฒะฐัััั ๐',
  ],
};

// ะะฑัะธะต ะผะพัะธะฒะฐัะธะพะฝะฝัะต ััะฐะทั
const GENERAL_PHRASES = [
  'ะขั ะฝะฐ ะฒะตัะฝะพะผ ะฟััะธ! ๐',
  'ะะฐะถะดะฐั ัะตะบัะฝะดะฐ ัะพะบััะฐ = ัะตะทัะปััะฐั ๐ฏ',
  'ะะพะฝัะตะฝััะฐัะธั โ ัะฒะพั ััะฟะตััะธะปะฐ! ๐',
  'ะัะพะดะพะปะถะฐะน ะฒ ัะพะผ ะถะต ะดััะต! ๐ฅ',
  'ะะตะปะธะบะธะต ะดะตะปะฐ ััะตะฑััั ะฒัะตะผะตะฝะธ โณ',
  'ะคะพะบัั โ ะบะปัั ะบ ัะพััั ๐ฑ',
  'ะขะฒะพะน ะปะตั ัะฐัััั ั ะบะฐะถะดะพะน ะผะธะฝััะพะน! ๐ฒ',
  'ะะพััะพัะฝััะฒะพ ะฟะพะฑะตะถะดะฐะตั ๐ช',
  'ะขั ะดะตะปะฐะตัั ัะพ, ััะพ ะฒะฐะถะฝะพ! ๐ฏ',
  'ะะฐะถะดัะน ัะฐะณ ะฟัะธะฑะปะธะถะฐะตั ะบ ัะตะปะธ ๐',
  'ะะต ะพััะฐะฝะฐะฒะปะธะฒะฐะนัั ัะตะนัะฐั! ๐',
  'ะขั ะผะพะถะตัั ะฑะพะปััะต, ัะตะผ ะดัะผะฐะตัั ๐',
  'ะกะธะปะฐ ะฒ ะฟะพััะพัะฝััะฒะต ๐',
  'ะะฐะปะตะฝัะบะธะต ัะฐะณะธ = ะฑะพะปััะธะต ัะตะทัะปััะฐัั ๐',
  'ะขะฒะพั ัะตะปั ะฑะปะธะถะต, ัะตะผ ะบะฐะถะตััั ๐ฏ',
  'ะคะพะบัั ัะตะณะพะดะฝั = ััะฟะตั ะทะฐะฒััะฐ โจ',
  'ะขั ะฒะบะปะฐะดัะฒะฐะตัั ะฒ ัะตะฑั! ๐ฐ',
  'ะัะตะผั ะธะฝะฒะตััะธัะพะฒะฐะฝะพ ะผัะดัะพ โฐ',
  'ะะพะฝัะตะฝััะฐัะธั ะดะตะปะฐะตั ัะตะฑั ะฝะตะฟะพะฑะตะดะธะผัะผ ๐ก๏ธ',
  'ะัะพะดะพะปะถะฐะน ัััะพะธัั ัะฒะพั ะธะผะฟะตัะธั! ๐ฐ',
];

@Injectable({
  providedIn: 'root',
})
export class MotivationService {
  private readonly storage = inject(StorageService);

  readonly currentPhrase = signal<string>(''); // ะัะพััะพ ัััะพะบะฐ
  private intervalId: any = null;
  private phraseIndex = 0;
  private currentPhrases: string[] = [];

  start(): void {
    const lastReason = this.storage.getLastGiveUpReason();
    
    // ะัะปะธ ะตััั ะฟัะธัะธะฝะฐ ะฟัะพัะปะพะณะพ ัะดะฐัะธ โ ะธัะฟะพะปัะทัะตะผ ัะฟะตัะธะฐะปัะฝัะต ััะฐะทั
    if (lastReason && PHRASES_BY_REASON[lastReason]) {
      // ะะตัะฒะฐั ััะฐะทะฐ โ ะฟะพ ะฟัะธัะธะฝะต, ะฟะพัะพะผ โ ะพะฑัะธะต
      this.currentPhrases = [
        ...PHRASES_BY_REASON[lastReason],
        ...GENERAL_PHRASES
      ];
    } else {
      // ะขะพะปัะบะพ ะพะฑัะธะต ััะฐะทั
      this.currentPhrases = [...GENERAL_PHRASES];
    }

    // ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟะตัะฒัั ััะฐะทั
    this.currentPhrase.set(this.currentPhrases[0]);
    this.phraseIndex = 1;

    // ะะตะฝัะตะผ ััะฐะทั ะบะฐะถะดัะต 15 ัะตะบัะฝะด
    this.intervalId = setInterval(() => {
      this.rotate();
    }, 15000);
  }

  stop(): void {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.currentPhrase.set('');
    this.phraseIndex = 0;
    this.currentPhrases = [];
  }

  private rotate(): void {
    this.currentPhrase.set(this.currentPhrases[this.phraseIndex % this.currentPhrases.length]);
    this.phraseIndex++;
  }
}
