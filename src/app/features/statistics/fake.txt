<div class="statistics">
    <header class="statistics__header">
      <button class="statistics__menu-btn" aria-label="Menu" (click)="onMenuClick()">
        <svg width="30" height="20" viewBox="0 0 30 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.66667 20C1.19445 20 0.798895 19.84 0.480006 19.52C0.161117 19.2 0.00111686 18.8044 5.74712e-06 18.3333C-0.00110536 17.8622 0.158895 17.4667 0.480006 17.1467C0.801117 16.8267 1.19667 16.6667 1.66667 16.6667H28.3333C28.8056 16.6667 29.2017 16.8267 29.5217 17.1467C29.8417 17.4667 30.0011 17.8622 30 18.3333C29.9989 18.8044 29.8389 19.2006 29.52 19.5217C29.2011 19.8428 28.8056 20.0022 28.3333 20H1.66667ZM1.66667 11.6667C1.19445 11.6667 0.798895 11.5067 0.480006 11.1867C0.161117 10.8667 0.00111686 10.4711 5.74712e-06 10C-0.00110536 9.52889 0.158895 9.13333 0.480006 8.81333C0.801117 8.49333 1.19667 8.33333 1.66667 8.33333H28.3333C28.8056 8.33333 29.2017 8.49333 29.5217 8.81333C29.8417 9.13333 30.0011 9.52889 30 10C29.9989 10.4711 29.8389 10.8672 29.52 11.1883C29.2011 11.5094 28.8056 11.6689 28.3333 11.6667H1.66667ZM1.66667 3.33333C1.19445 3.33333 0.798895 3.17333 0.480006 2.85333C0.161117 2.53333 0.00111686 2.13778 5.74712e-06 1.66667C-0.00110536 1.19556 0.158895 0.8 0.480006 0.48C0.801117 0.16 1.19667 0 1.66667 0H28.3333C28.8056 0 29.2017 0.16 29.5217 0.48C29.8417 0.8 30.0011 1.19556 30 1.66667C29.9989 2.13778 29.8389 2.53389 29.52 2.855C29.2011 3.17611 28.8056 3.33556 28.3333 3.33333H1.66667Z" fill="white"/></svg>
      </button>
    </header>
    <span class="statistics__label">Статистика</span>
  
  <!-- переключатель режима -->
    <div class="stat-switcher">
      <button [class.active]="activeMode() === 'day'" (click)="setMode('day')">День</button>
      <button [class.active]="activeMode() === 'week'" (click)="setMode('week')">Неделя</button>
      <button [class.active]="activeMode() === 'month'" (click)="setMode('month')">Месяц</button>
    </div>
  
    <div class="stat-calendar">
      <div class="stat-scroll">
  
        <!-- Режим ДЕНЬ: календарь -->
        <ng-container *ngIf="activeMode() === 'day'">
          <app-calendar
            [initialDate]="selectedDateISO"
            (dateSelected)="onDateSelected($event)">
          </app-calendar>
        </ng-container>
  
        <!-- Режим НЕДЕЛЯ: селектор диапазона -->
        <ng-container *ngIf="activeMode() === 'week'">
          <div class="week-range">
            <button
              class="week-range__btn"
              (click)="onDateSelected(formatDate(new Date(selectedDate.getTime() - 7*24*60*60*1000)))">
              ‹
            </button>
  
            <span class="week-range__label">{{ weekRangeLabel }}</span>
  
            <button
              class="week-range__btn"
              (click)="onDateSelected(formatDate(new Date(selectedDate.getTime() + 7*24*60*60*1000)))">
              ›
            </button>
          </div>
        </ng-container>
  
      <!-- БОЛЬШАЯ КАРТОЧКА ДНЯ -->
      <div class="stats-main-card">
        <div class="stats-day-title">
          <ng-container *ngIf="activeMode() === 'day'; else weekTitle">
            {{ todayLabel | titlecase }}
          </ng-container>
          <ng-template #weekTitle>
            {{ weekRangeLabel }}
          </ng-template>
        </div>
  
        <div class="stats-cards">
          <!-- Текущие сессии -->
          <div class="stats-card">
            <div class="stats-card-block">
                <div class="stats-card-icon">
                  <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.4939 15.8603L15.9085 10.4457L14.5429 9.08008L10.4939 13.129L8.45749 11.0926L7.09186 12.4582L10.4939 15.8603ZM11.5002 21.0832C10.3023 21.0832 9.18039 20.8558 8.13453 20.4009C7.08867 19.946 6.17825 19.3311 5.40328 18.5561C4.62831 17.7811 4.01338 16.8707 3.55849 15.8248C3.1036 14.779 2.87583 13.6568 2.8752 12.4582C2.87456 11.2596 3.10232 10.1378 3.55849 9.09254C4.01465 8.04731 4.62926 7.1369 5.40232 6.36129C6.17538 5.58568 7.08579 4.97074 8.13357 4.51649C9.18135 4.06224 10.3036 3.83448 11.5002 3.8332C12.6968 3.83193 13.819 4.05969 14.8668 4.51649C15.9146 4.9733 16.825 5.58823 17.5981 6.36129C18.3711 7.13434 18.9861 8.04476 19.4429 9.09254C19.8997 10.1403 20.1271 11.2622 20.1252 12.4582C20.1233 13.6542 19.8958 14.7764 19.4429 15.8248C18.9899 16.8732 18.375 17.7837 17.5981 18.5561C16.8212 19.3285 15.9108 19.9434 14.8668 20.4009C13.8229 20.8583 12.7007 21.0858 11.5002 21.0832ZM5.36686 2.25195L6.70853 3.59362L2.63561 7.66654L1.29395 6.32487L5.36686 2.25195ZM17.6335 2.25195L21.7064 6.32487L20.3648 7.66654L16.2919 3.59362L17.6335 2.25195ZM11.5002 19.1665C13.3689 19.1665 14.9543 18.5158 16.2564 17.2144C17.5585 15.913 18.2092 14.3276 18.2085 12.4582C18.2079 10.5888 17.5572 9.00373 16.2564 7.70295C14.9556 6.40218 13.3702 5.75115 11.5002 5.74987C9.63017 5.74859 8.04508 6.39962 6.74495 7.70295C5.44481 9.00629 4.79378 10.5914 4.79186 12.4582C4.78995 14.325 5.44097 15.9104 6.74495 17.2144C8.04892 18.5184 9.634 19.1691 11.5002 19.1665Z" fill="black" fill-opacity="0.78"/>
                  </svg>
                </div>
                <div class="stats-card-text">
                  <div class="stats-card-val">{{ stats?.kpi?.current_count ?? 0 }}</div>
                </div>
            </div>
            <div class="stats-card-label">Текущие сессии</div>
          </div>
  
          <!-- Суммарные минуты -->
          <div class="stats-card">
           <div class="stats-card-block">
            <div class="stats-card-icon">
              <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.5003 19.167C13.5337 19.167 15.4837 18.3593 16.9215 16.9215C18.3593 15.4837 19.167 13.5337 19.167 11.5003C19.167 9.467 18.3593 7.51695 16.9215 6.07917C15.4837 4.64139 13.5337 3.83366 11.5003 3.83366C9.467 3.83366 7.51695 4.64139 6.07917 6.07917C4.64139 7.51695 3.83366 9.467 3.83366 11.5003C3.83366 13.5337 4.64139 15.4837 6.07917 16.9215C7.51695 18.3593 9.467 19.167 11.5003 19.167ZM11.5003 1.91699C12.7588 1.91699 14.005 2.16487 15.1677 2.64648C16.3304 3.12809 17.3869 3.83399 18.2768 4.72389C19.1667 5.61378 19.8726 6.67024 20.3542 7.83294C20.8358 8.99565 21.0837 10.2418 21.0837 11.5003C21.0837 14.042 20.074 16.4795 18.2768 18.2768C16.4795 20.074 14.042 21.0837 11.5003 21.0837C6.20074 21.0837 1.91699 16.7712 1.91699 11.5003C1.91699 8.95867 2.92666 6.52111 4.72389 4.72389C6.52111 2.92666 8.95867 1.91699 11.5003 1.91699ZM11.9795 6.70866V11.7399L16.292 14.2987L15.5732 15.4774L10.542 12.4587V6.70866H11.9795Z" fill="black" fill-opacity="0.78"/>
              </svg>
            </div>
            <div class="stats-card-text">
              <div class="stats-card-val">{{ stats?.kpi?.total_minutes ?? 0 }}</div>
            </div>
          </div>
          <div class="stats-card-label">Суммарные минуты</div>
          </div>
  
          <!-- Завершённые сессии -->
          <div class="stats-card">
            <div class="stats-card-block">
            <div class="stats-card-icon">
                <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.4939 13.129L9.12825 11.7633C8.93659 11.5717 8.71298 11.4758 8.45742 11.4758C8.20187 11.4758 7.97825 11.5717 7.78659 11.7633C7.59492 11.955 7.49909 12.1828 7.49909 12.4466C7.49909 12.7105 7.59492 12.9379 7.78659 13.129L9.82305 15.1894C10.0147 15.3811 10.2383 15.4769 10.4939 15.4769C10.7494 15.4769 10.973 15.3811 11.1647 15.1894L15.2376 11.1165C15.4293 10.9248 15.5251 10.6974 15.5251 10.4341C15.5251 10.1709 15.4293 9.94315 15.2376 9.75085C15.046 9.55854 14.8185 9.46271 14.5553 9.46335C14.2921 9.46398 14.0643 9.55982 13.872 9.75085L10.4939 13.129ZM11.5001 21.0831C10.3022 21.0831 9.18032 20.8557 8.13446 20.4008C7.0886 19.9459 6.17819 19.331 5.40321 18.556C4.62824 17.781 4.01331 16.8706 3.55842 15.8248C3.10353 14.7789 2.87577 13.6567 2.87513 12.4581C2.87449 11.2596 3.10226 10.1377 3.55842 9.09247C4.01459 8.04725 4.6292 7.13683 5.40226 6.36122C6.17531 5.58561 7.08573 4.97068 8.13351 4.51643C9.18128 4.06218 10.3035 3.83442 11.5001 3.83314C12.6968 3.83186 13.819 4.05962 14.8668 4.51643C15.9145 4.97323 16.825 5.58817 17.598 6.36122C18.3711 7.13428 18.986 8.04469 19.4428 9.09247C19.8996 10.1402 20.127 11.2621 20.1251 12.4581C20.1232 13.6541 19.8958 14.7763 19.4428 15.8248C18.9898 16.8732 18.3749 17.7836 17.598 18.556C16.8211 19.3284 15.9107 19.9434 14.8668 20.4008C13.8228 20.8582 12.7006 21.0857 11.5001 21.0831ZM1.96471 6.99564C1.78902 6.81994 1.70117 6.59633 1.70117 6.3248C1.70117 6.05328 1.78902 5.82967 1.96471 5.65397L4.69596 2.92272C4.87166 2.74703 5.09527 2.65918 5.3668 2.65918C5.63832 2.65918 5.86194 2.74703 6.03763 2.92272C6.21332 3.09842 6.30117 3.32203 6.30117 3.59355C6.30117 3.86508 6.21332 4.08869 6.03763 4.26439L3.30638 6.99564C3.13069 7.17133 2.90707 7.25918 2.63555 7.25918C2.36402 7.25918 2.14041 7.17133 1.96471 6.99564ZM21.0355 6.99564C20.8599 7.17133 20.6362 7.25918 20.3647 7.25918C20.0932 7.25918 19.8696 7.17133 19.6939 6.99564L16.9626 4.26439C16.7869 4.08869 16.6991 3.86508 16.6991 3.59355C16.6991 3.32203 16.7869 3.09842 16.9626 2.92272C17.1383 2.74703 17.3619 2.65918 17.6335 2.65918C17.905 2.65918 18.1286 2.74703 18.3043 2.92272L21.0355 5.65397C21.2112 5.82967 21.2991 6.05328 21.2991 6.3248C21.2991 6.59633 21.2112 6.81994 21.0355 6.99564Z" fill="black" fill-opacity="0.78"/>
                </svg>
            </div>
            <div class="stats-card-text">
              <div class="stats-card-val">{{ stats?.kpi?.completed_count ?? 0 }}</div>
            </div>
          </div>
          <div class="stats-card-label">Завершенные сессии</div>
          </div>
  
          <!-- Успешные сессии -->
          <div class="stats-card">
            <div class="stats-card-block">
            <div class="stats-card-icon">
                <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19.4257 15.5868L20.1014 11.6768C20.141 11.4477 20.1301 11.2126 20.0694 10.9881C20.0087 10.7636 19.8997 10.555 19.75 10.377C19.6003 10.199 19.4136 10.0559 19.2028 9.95762C18.992 9.85934 18.7623 9.80831 18.5297 9.80808H13.5646C13.4487 9.80811 13.3342 9.78291 13.229 9.73423C13.1239 9.68555 13.0306 9.61457 12.9556 9.5262C12.8807 9.43784 12.8259 9.33422 12.795 9.22253C12.7641 9.11085 12.7579 8.99378 12.7768 8.87946L13.4122 5.003C13.5148 4.37357 13.4854 3.72968 13.3259 3.11221C13.2571 2.8573 13.1251 2.62385 12.9422 2.43341C12.7593 2.24297 12.5314 2.10168 12.2794 2.02258L12.1405 1.97754C11.8263 1.87701 11.4855 1.90032 11.1879 2.04271C10.8621 2.19988 10.6244 2.48642 10.5362 2.82663L10.0801 4.58421C9.93508 5.1436 9.72404 5.68374 9.4514 6.19325C9.05369 6.93788 8.43844 7.53492 7.79827 8.08596L6.41923 9.27429C6.22792 9.43962 6.0785 9.64791 5.98322 9.88212C5.88794 10.1163 5.8495 10.3698 5.87107 10.6217L6.64923 19.6233C6.68353 20.0214 6.86586 20.3922 7.16021 20.6624C7.45456 20.9326 7.83953 21.0827 8.23911 21.0829H12.6934C16.0304 21.0829 18.8776 18.758 19.4257 15.5868Z" fill="black" fill-opacity="0.78"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.84441 9.08955C3.02962 9.08146 3.21079 9.14523 3.35008 9.26756C3.48938 9.38989 3.57602 9.56131 3.59191 9.74601L4.52149 20.5138C4.53724 20.6742 4.52013 20.8361 4.47122 20.9896C4.42231 21.1431 4.34261 21.285 4.237 21.4067C4.1314 21.5284 4.00209 21.6273 3.85699 21.6973C3.71188 21.7674 3.55403 21.8071 3.39306 21.8141C3.23209 21.821 3.07138 21.7951 2.92076 21.7379C2.77014 21.6807 2.63276 21.5934 2.51702 21.4813C2.40128 21.3692 2.3096 21.2347 2.24758 21.086C2.18557 20.9373 2.15451 20.7775 2.15632 20.6164V9.80735C2.1564 9.62208 2.22801 9.44401 2.35622 9.31027C2.48442 9.17653 2.65931 9.09746 2.84441 9.08955Z" fill="black" fill-opacity="0.78"/>
                </svg>
            </div>
            <div class="stats-card-text">
              <div class="stats-card-val">{{ (stats?.kpi?.success_rate ?? 0) | percent:'1.0-0' }}</div>
            </div>
          </div>
          <div class="stats-card-label">Успешные сессии</div>
          </div>
        </div>
      </div>
  
      <div class="streak-row">
        <div class="streak-card">
          <div class="streak-title">Текущий Streak</div>
      
          <div class="streak-center">
            <div class="streak-icon">
              <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.1104 17.4419L15.0697 11.5002H11.2364L11.9312 6.0617L7.4989 12.4586H10.8291L10.1104 17.4419ZM8.62494 14.3752H5.65411C5.27077 14.3752 4.98711 14.2037 4.80311 13.8606C4.61911 13.5175 4.63923 13.1859 4.86348 12.8659L12.027 2.56378C12.1867 2.34017 12.3944 2.1846 12.6499 2.09707C12.9055 2.00954 13.169 2.01338 13.4406 2.10857C13.7121 2.20377 13.9117 2.37147 14.0395 2.6117C14.1673 2.85192 14.2152 3.10747 14.1833 3.37836L13.4166 9.58357H17.1301C17.5454 9.58357 17.8371 9.76725 18.0051 10.1346C18.1731 10.502 18.1211 10.8454 17.8489 11.1648L9.9666 20.6044C9.79091 20.812 9.57529 20.9478 9.31973 21.0117C9.06417 21.0756 8.8166 21.0516 8.57702 20.9398C8.33744 20.828 8.14992 20.6565 8.01448 20.4252C7.87904 20.1939 7.82697 19.9422 7.85827 19.67L8.62494 14.3752Z" fill="black" fill-opacity="0.78"/>
              </svg>
            </div>
            <div class="streak-value">{{ currentStreak }}</div>
          </div>
      
          <div class="streak-info">дня</div>
        </div>
  
        <div class="streak-card">
          <div class="streak-title">Лучший Streak</div>
            <div class="streak-center">
              <div class="streak-icon">
                <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9.8273 1.3291L11.0348 2.0536C12.5663 2.95891 13.7429 4.35996 14.3698 6.02494C14.5826 5.54577 14.8356 5.08098 15.0703 4.61139L16.0105 5.55152C18.1207 7.66177 20.1246 10.8243 20.1246 13.8957C20.1246 18.0146 17.585 20.6261 13.5217 21.0775L12.1896 21.2251L12.4809 19.9169C12.7081 18.8934 12.7493 18.2245 12.7013 17.7559C12.6438 17.1665 12.364 16.7036 12.0152 16.2436C11.6817 15.8028 11.3511 15.361 11.0866 14.8732C9.99885 15.7329 9.57718 16.5091 9.44205 17.1483C9.26955 17.9667 9.51393 18.8034 9.96051 19.6965L10.7483 21.272L8.99835 21.0775C6.52968 20.8034 4.09743 19.1541 3.1391 16.7477C2.13764 14.2302 2.84585 11.1836 6.08118 8.37956C8.22785 6.51944 9.36443 4.10731 9.8273 1.3291ZM11.1038 4.4916C10.3736 6.54244 8.97151 8.41118 7.33564 9.82856C4.54593 12.2464 4.2958 14.4707 4.92064 16.0386C5.38543 17.2077 6.3888 18.1689 7.5781 18.7142C7.43915 18.0684 7.43523 17.4009 7.5666 16.7535C7.87901 15.2719 8.94468 13.8833 10.9917 12.6039L12.0238 11.9589L12.4091 13.1137C12.7464 14.1257 13.446 14.8416 13.9932 15.73C14.595 16.7075 14.71 17.8287 14.5873 18.9481C17.0982 18.3204 18.2079 16.4161 18.2079 13.8957C18.2079 11.7663 16.9238 9.67714 15.6492 8.04414C15.124 9.22098 14.0171 9.63498 12.9371 10.1755V8.62489C12.9371 7.31293 12.4033 5.71348 11.1038 4.49256V4.4916Z" fill="black" fill-opacity="0.78"/>
                </svg>
              </div>
              <div class="streak-value">{{ bestStreak }}</div>
          </div>
          <div class="streak-info">дня</div>
        </div>
      </div>
  
      <!-- дальше твои графики фокуса, причины срывов, топ теги -->
      <div class="focus-chart-card">
        <div class="focus-chart-title">Время фокуса</div>
      
        <apx-chart
          [series]="focusBarSeries"
          [chart]="focusBarChart"
          [colors]="focusBarColors"
          [xaxis]="focusBarXAxis"
          [plotOptions]="focusBarPlotOptions"
          [dataLabels]="focusBarDataLabels"
          [grid]="focusBarGrid"
          [legend]="focusBarLegend"
          [yaxis]="focusBarYAxis"
        ></apx-chart>
      </div>
  
      <div class="stats-row">
        <!-- Причины срывов -->
        <div class="stats-square">
          <div class="sq-title">Причины срывов</div>
      
          <div class="donut-wrap">
            <apx-chart
              [series]="pieChartOptions.series"
              [chart]="pieChartOptions.chart"
              [labels]="pieChartOptions.labels"
              [colors]="pieChartOptions.colors"
              [tooltip]="pieChartOptions.tooltip"
              [responsive]="pieChartOptions.responsive"
              [legend]="pieChartOptions.legend"
              [plotOptions]="pieChartOptions.plotOptions"
              [dataLabels]="pieChartOptions.dataLabels"
            ></apx-chart>
          </div>
      
          <div class="donut-legend" *ngIf="stats?.charts?.fail_reasons?.length">
            <div
              class="donut-legend-item"
              *ngFor="let item of stats.charts.fail_reasons; let i = index"
            >
              <span
                class="donut-legend-dot"
                [style.background-color]="pieChartOptions.colors[i % pieChartOptions.colors.length]"
              ></span>
              <span class="donut-legend-label">{{ item.reason }}</span>
            </div>
          </div>
        </div>
      
        <!-- Топ теги -->
        <div class="stats-square">
          <div class="sq-title">Топ теги</div>
      
          <div class="donut-wrap">
            <apx-chart
              [series]="tagsChartOptions.series"
              [chart]="tagsChartOptions.chart"
              [labels]="tagsChartOptions.labels"
              [colors]="tagsChartOptions.colors"
              [tooltip]="tagsChartOptions.tooltip"
              [responsive]="tagsChartOptions.responsive"
              [legend]="tagsChartOptions.legend"
              [plotOptions]="tagsChartOptions.plotOptions"
              [dataLabels]="tagsChartOptions.dataLabels"
            ></apx-chart>
          </div>
      
          <div class="donut-legend" *ngIf="stats?.charts?.tags?.length">
            <div
              class="donut-legend-item"
              *ngFor="let item of stats.charts.tags; let i = index"
            >
              <span
                class="donut-legend-dot"
                [style.background-color]="tagsChartOptions.colors[i % tagsChartOptions.colors.length]"
              ></span>
              <span class="donut-legend-label">{{ getTagLabel(item.tag) }}</span>
            </div>
          </div>
        </div>
      </div>
    
    <app-sidebar-menu
      *ngIf="showSidebarMenu"
      (closed)="onMenuClosed()"
      (itemSelected)="onMenuItemSelected($event)">
    </app-sidebar-menu>
  </div>
  